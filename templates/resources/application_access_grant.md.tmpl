# {{.Name}} ({{.Type}})

{{ .Description | trimspace }}

## Note
- Application Access Grant cannot be edited
- Cancel grant by destroying application_access_grant
- Read more: https://docs.axual.io/axual/2025.3/self-service/topic-authorizations.html#contents

## Usage
- To request access to a topic, create an application_access_grant
- To cancel a grant, delete the application_access_grant
- Application Access Grant that are auto authorized do not need any further action.
- Application Access Grant that required further action can be handled with application_access_grant_approval and application_access_grant_rejection.

## Required Roles
- APPLICATION_ADMIN or be part of the Team that owns the Application

{{ .SchemaMarkdown | trimspace }}

## State Synchronization

~> **Important:** The `status` attribute is computed and may become stale when another resource modifies the grant.

### When Does This Happen?

When you create an `axual_application_access_grant_approval` or `axual_application_access_grant_rejection` resource, it changes the grant's status via the API. However, the grant resource's Terraform state is **not automatically updated** - it still shows the previous status until the next refresh.

**Example timeline:**

```
1. terraform apply (creates grant)     → state: status = "Pending"
2. terraform apply (creates approval)  → API changes grant to "Approved"
                                       → grant state still shows "Pending" (STALE)
3. terraform refresh (or next apply)   → state syncs: status = "Approved"
```

### How to Sync the State

Run any of these commands to refresh the grant's status from the API:

```shell
terraform refresh
# or
terraform apply
```

### Why This Happens

This is expected Terraform behavior. When one resource modifies another resource via the API, Terraform's state for the modified resource is not automatically updated. The state file is only updated when you run `terraform apply` or `terraform refresh`.

~> **Note:** In normal workflows, you won't notice this issue because `terraform apply` reads current state from the API during its refresh phase, showing you accurate information. However, the state **file** itself is only updated when you run `terraform apply` or `terraform refresh`. The stale state only matters if you inspect the state file directly without running one of these commands first.

## Checking Grant Status

To check the current status of a grant:

```shell
# Refresh state from the API
terraform refresh

# Show the grant's current status
terraform state show axual_application_access_grant.my_grant
```

Example output:

```
# axual_application_access_grant.my_grant:
resource "axual_application_access_grant" "my_grant" {
    access_type = "PRODUCER"
    application = "b67f7c3b03a646b3b86b6a3320ddf1f3"
    environment = "b10456f91c634e2aadbc3ad64b20f10b"
    id          = "a7b9346f4e9a49ebb6934553dbc246c3"
    status      = "Revoked"
    topic       = "4fa97a80527f4977befe91ce80893621"
}
```

The `status` attribute determines what actions are available:

| Status | Can Create Approval? | Can Delete Grant? |
|--------|---------------------|-------------------|
| `Pending` | ✅ Yes | ✅ Yes (cancels) |
| `Approved` | ✅ Yes (adopts into state) | ✅ Yes (auto-revokes first) |
| `Revoked` | ❌ No - must recreate grant | ✅ Yes (removes from state) |
| `Rejected` | ❌ No - must recreate grant | ✅ Yes (removes from state) |
| `Cancelled` | ❌ No - must recreate grant | ✅ Yes (removes from state) |

~> **Important:** Revoked, Rejected, and Cancelled are terminal states. To request access again, delete the grant resource and recreate it.

## Example Usage

```hcl
resource "axual_application_access_grant" "dash_consume_from_logs_in_dev" {
  application = axual_application.dev_dashboard.id
  topic = axual_topic.logs.id
  environment = axual_environment.development.id
  access_type = "CONSUMER"
  depends_on = [
    axual_application_principal.log_scraper_in_dev_principal,
    axual_topic_config.logs_in_dev
  ]
}
```

For a full example which shows the capabilities of the latest TerraForm provider, check https://github.com/Axual/terraform-provider-axual/tree/master/examples/axual.

## Import

Application Access Grant can be imported using the grant's UID:

```shell
terraform import axual_application_access_grant.example 1234567890abcdef1234567890abcdef
```

### Notes

- The grant UID can be found in the Axual Self-Service UI or via the API
- All grant attributes (`application`, `topic`, `environment`, `access_type`, `status`) are populated during import
- Grants in any status (Pending, Approved, Rejected, Revoked, Cancelled) can be imported

### Delete Behavior

When deleting an `axual_application_access_grant`:

| Grant Status | Delete Action |
|--------------|---------------|
| Pending | Grant is cancelled |
| Approved | Grant is automatically revoked, then removed from state |
| Rejected | Grant is removed from state |
| Revoked | Grant is removed from state |
| Cancelled | Grant is removed from state |

This means you no longer need a separate `axual_application_access_grant_approval` resource just for cleanup in Auto environments - approved grants are auto-revoked on delete.